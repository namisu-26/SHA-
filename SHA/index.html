<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>·ª®ng d·ª•ng truy·ªÅn file qua WebSocket c√≥ ki·ªÉm tra SHA-256</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f2f5;
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; align-items: center;
  }
  h1 { color: #333; }
  #roleSelect {
    margin-bottom: 20px;
  }
  #container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    width: 400px;
    text-align: center;
  }
  input[type="file"] {
    margin-top: 10px;
  }
  button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
    border: none;
    background-color: #2980b9;
    color: white;
    border-radius: 6px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #3498db;
  }
  #status, #statusB {
    margin-top: 15px;
    font-weight: bold;
    min-height: 24px;
  }
  #fileHash, #fileHashB, #checkResult {
    margin-top: 15px;
    font-family: monospace;
    word-break: break-word;
  }
  #downloadLink {
    margin-top: 15px;
    display: none;
    text-decoration: none;
    color: #fff;
    background: #27ae60;
    padding: 10px 15px;
    border-radius: 8px;
  }
  #downloadLink:hover {
    background: #2ecc71;
  }
</style>
</head>
<body>

<h1>Truy·ªÅn file qua WebSocket - Ki·ªÉm tra SHA-256</h1>

<label for="roleSelect">Ch·ªçn vai tr√≤:</label>
<select id="roleSelect">
  <option value="A">Web A (G·ª≠i file)</option>
  <option value="B">Web B (Nh·∫≠n file)</option>
</select>

<div id="container">
  <!-- Ph·∫ßn Web A -->
  <div id="sender" style="display: none;">
    <input type="file" id="fileInput" />
    <br/>
    <button id="sendBtn">G·ª≠i file</button>
    <div id="status"></div>
    <div id="fileHash"></div>
  </div>

  <!-- Ph·∫ßn Web B -->
  <div id="receiver" style="display: none;">
    <div id="statusB">Ch∆∞a nh·∫≠n file</div>
    <div id="fileHashB"></div>
    <div id="checkResult"></div>
    <a id="downloadLink" href="#" download>‚¨áÔ∏è T·∫£i file</a>
  </div>
</div>

<!-- CryptoJS th∆∞ vi·ªán ƒë·ªÉ t√≠nh SHA-256 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
  const roleSelect = document.getElementById('roleSelect');
  const senderDiv = document.getElementById('sender');
  const receiverDiv = document.getElementById('receiver');

  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const status = document.getElementById('status');
  const fileHashDiv = document.getElementById('fileHash');

  const statusB = document.getElementById('statusB');
  const fileHashB = document.getElementById('fileHashB');
  const checkResult = document.getElementById('checkResult');
  const downloadLink = document.getElementById('downloadLink');

  let ws;

  function updateStatus(msg) {
    if (roleSelect.value === 'A') {
      status.textContent = msg;
    } else {
      statusB.textContent = msg;
    }
  }

  function setupWebSocket() {
    if (ws) {
      ws.close();
    }

    ws = new WebSocket("ws://localhost:8080");

    ws.onopen = () => {
      updateStatus("‚úÖ ƒê√£ k·∫øt n·ªëi WebSocket.");
    };
    ws.onerror = () => {
      updateStatus("‚ùå L·ªói k·∫øt n·ªëi WebSocket.");
    };
    ws.onclose = () => {
      updateStatus("‚ö†Ô∏è K·∫øt n·ªëi WebSocket ƒë√£ ƒë√≥ng.");
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (roleSelect.value === 'A') {
        if (data.status === "file_received_A") {
          updateStatus("‚úÖ Server ƒë√£ nh·∫≠n file.");
        }
      } else if (roleSelect.value === 'B') {
        if (data.status === "file_from_A") {
          const { filename, fileData, fileHash } = data;

          updateStatus(`üì• ƒê√£ nh·∫≠n file: ${filename}`);

          fileHashB.textContent = "SHA-256 g·ª≠i t·ª´ Web A: " + fileHash;

          // Gi·∫£i m√£ base64 v·ªÅ bytes
          const binaryStr = atob(fileData);
          const len = binaryStr.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryStr.charCodeAt(i);
          }

          // T√≠nh l·∫°i hash
          const wordArray = CryptoJS.lib.WordArray.create(bytes);
          const newHash = CryptoJS.SHA256(wordArray).toString();

          checkResult.textContent = "SHA-256 t√≠nh l·∫°i: " + newHash;

          if (newHash === fileHash) {
            checkResult.style.color = "green";
            checkResult.textContent += " ‚úîÔ∏è T√≠nh to√†n v·∫πn d·ªØ li·ªáu ƒë√∫ng!";
          } else {
            checkResult.style.color = "red";
            checkResult.textContent += " ‚ùå D·ªØ li·ªáu b·ªã thay ƒë·ªïi!";
          }

          // T·∫°o link t·∫£i file
          const blob = new Blob([bytes]);
          const url = URL.createObjectURL(blob);
          downloadLink.href = url;
          downloadLink.download = filename;
          downloadLink.style.display = "inline-block";
          downloadLink.textContent = `‚¨áÔ∏è T·∫£i file ${filename}`;
        }
      }
    };
  }

  roleSelect.addEventListener('change', () => {
    if (ws) ws.close();

    if (roleSelect.value === 'A') {
      senderDiv.style.display = 'block';
      receiverDiv.style.display = 'none';
    } else {
      senderDiv.style.display = 'none';
      receiverDiv.style.display = 'block';
      // Reset receiver UI
      statusB.textContent = "Ch∆∞a nh·∫≠n file";
      fileHashB.textContent = "";
      checkResult.textContent = "";
      downloadLink.style.display = "none";
    }
    setupWebSocket();
  });

  // Kh·ªüi t·∫°o v·ªõi vai tr√≤ m·∫∑c ƒë·ªãnh l√† Web A
  roleSelect.value = 'A';
  roleSelect.dispatchEvent(new Event('change'));

  sendBtn.onclick = () => {
    const file = fileInput.files[0];
    if (!file) {
      alert("Vui l√≤ng ch·ªçn file tr∆∞·ªõc.");
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const bytes = new Uint8Array(e.target.result);
      const wordArray = CryptoJS.lib.WordArray.create(bytes);
      const hash = CryptoJS.SHA256(wordArray).toString();

      fileHashDiv.textContent = "SHA-256 c·ªßa file: " + hash;

      // M√£ h√≥a file base64
      let binary = '';
      for (let b of bytes) binary += String.fromCharCode(b);
      const base64Data = btoa(binary);

      // G·ª≠i file qua websocket
      ws.send(JSON.stringify({
        action: "send_file_A",
        filename: file.name,
        fileData: base64Data,
        fileHash: hash
      }));

      updateStatus("üì§ ƒêang g·ª≠i file...");
    };
    reader.readAsArrayBuffer(file);
  };
</script>

</body>
</html>
